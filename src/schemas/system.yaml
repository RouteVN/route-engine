$schema: http://json-schema.org/draft-07/schema#
title: System State Schema
description: Schema for system state in visual novel engine
type: object
properties:
  pendingEffects:
    type: array
    description: Array of pending effects to be processed
    items:
      type: object
      properties:
        name:
          type: string
          description: Name of the effect
          enum:
            [
              render,
              systemInstructions,
              cancelTimerEffect,
              updateLocalVariables,
              saveVnData,
            ]
        options:
          type: object
          description: Options for the effect
          properties:
            delay:
              type: number
              description: Delay in milliseconds
              minimum: 0
            systemInstructions:
              type: object
              description: System instructions to execute
              additionalProperties: true
            variables:
              type: object
              description: Variables to update
              additionalProperties: true
            saveData:
              type: array
              description: Save data to persist
              items:
                type: object
          additionalProperties: false
      required: [name]
      additionalProperties: false

  variables:
    type: object
    description: Runtime variables storage
    additionalProperties: true

  saveData:
    type: array
    description: Game save data
    items:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the save
        slotIndex:
          type: number
          description: Save slot index
          minimum: 0
        pointer:
          $ref: "#/definitions/Pointer"
          description: Pointer state at time of save
        history:
          $ref: "#/definitions/History"
          description: History state at time of save
      required: [id, slotIndex, pointer, history]
      additionalProperties: false

  story:
    type: object
    description: Main story state
    properties:
      lastLineAction:
        type: string
        description: Last action performed on a line
        enum: [nextLine, prevLine]

      dialogueUIHidden:
        type: boolean
        description: Whether dialogue UI is hidden
        default: false

      currentPointer:
        type: string
        description: Currently active pointer mode
        enum: [read, menu, history, title]
        default: read

      autoNext:
        type: object
        description: Auto-next configuration
        properties:
          nextTrigger:
            type: string
            description: When to trigger auto-next
            enum: [onComplete, fromComplete, manual]
          delay:
            type: number
            description: Delay in milliseconds
            minimum: 0
          delayAfterComplete:
            type: number
            description: Delay after completion
            minimum: 0
          preventManual:
            type: boolean
            description: Whether to prevent manual advancement
            default: false
        required: [nextTrigger]
        additionalProperties: false

      autoMode:
        type: boolean
        description: Whether auto mode is enabled
        default: false

      skipMode:
        type: boolean
        description: Whether skip mode is enabled
        default: false

      historyEntryIndex:
        type: number
        description: Current index in history entries
        minimum: 0

      pointers:
        type: object
        description: Collection of navigation pointers
        properties:
          read:
            $ref: "#/definitions/Pointer"
            description: Reading mode pointer
          menu:
            $ref: "#/definitions/Pointer"
            description: Menu mode pointer
          history:
            allOf:
              - $ref: "#/definitions/Pointer"
              - type: object
                properties:
                  historyEntryIndex:
                    type: number
                    description: Index in history entries
                    minimum: 0
            description: History mode pointer
          title:
            $ref: "#/definitions/Pointer"
            description: Title screen pointer
        required: [read, menu, history]
        additionalProperties: false

      history:
        $ref: "#/definitions/History"
        description: Story progression history

    required:
      [dialogueUIHidden, currentPointer, autoMode, skipMode, pointers, history]
    additionalProperties: false

required: [pendingEffects, variables, saveData, story]
additionalProperties: false

definitions:
  Pointer:
    type: object
    description: Navigation pointer for different modes
    properties:
      presetId:
        type: string
        description: Current preset ID
      sectionId:
        type: string
        description: Current section ID
      lineId:
        type: string
        description: Current line ID
      sceneId:
        type: string
        description: Current scene ID (optional)
    additionalProperties: false

  History:
    type: object
    description: Story progression history
    properties:
      entries:
        type: array
        description: Array of history entries
        items:
          type: object
          properties:
            sectionId:
              type: string
              description: Section ID for this history entry
            lineId:
              type: string
              description: Line ID for this history entry (optional)
            sceneId:
              type: string
              description: Scene ID for this history entry (optional)
          required: [sectionId]
          additionalProperties: false
    required: [entries]
    additionalProperties: false

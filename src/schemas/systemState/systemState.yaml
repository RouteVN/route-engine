$schema: http://json-schema.org/draft-07/schema#
title: System State Schema
description: Schema for the visual novel engine system state
type: object

defs:
  linePointer:
    type: object
    description: Pointer to a specific location in the story
    properties:
      sectionId:
        type: string
        description: ID of the section
      lineId:
        type: string
        description: ID of the line within the section
    required: [sectionId, lineId]
    additionalProperties: false

properties:
  global:
    type: object
    description: global state, regardless of context
    properties:
      pendingEffects:
        type: array
        description: Array of pending effects to be processed
        items:
          $ref: "effects.yaml"
        default: []

      # TODO: decide what to do with this in terms of context
      # here we put only global-device, and global-account variables
      # context variables will go to context
      variables:
        type: object
        description: Game variables and their current values
        properties:
          "^[a-zA-Z0-9]+$": # variable id
            type: object
            description: variable object
            properties:
              value: any
              description: value of the variable
              additionalProperties: true
        default: {}

      saveSlots:
        type: object
        description: Save game slots indexed by slotKey
        properties:
          "^.+$": # slot key (string like "1", "autosave", etc.)
            type: object
            properties:
              slotKey:
                type: string
              date:
                type: integer
                description: Unix timestamp
              image:
                type: string
                description: Base64 screenshot (null if none)
              state:
                type: object
                description: Full system state
            required: [slotKey, date, state]
        default: {}

      # TODO: don't remember why we need this for
      # lastLineAction:
      #   type: object
      #   description: The last action executed
      #   additionalProperties: true

      dialogueUIHidden:
        type: boolean
        description: Whether the dialogue UI is currently hidden
        default: false

      autoMode:
        type: boolean
        description: Whether auto-advance mode is active
        default: false

      skipMode:
        type: boolean
        description: Whether skip mode is active
        default: false

      currentLanguagePackId:
        type: string
        description: ID of the currently active language pack

      # history:
      #   type: object
      #   description: Navigation history
      #   properties:
      #     entries:
      #       type: array
      #       description: Array of history entries
      #       items:
      #         type: object
      #         properties:
      #           sectionId:
      #             type: string
      #             description: ID of the section
      #           lineId:
      #             type: string
      #             description: ID of the current line (only on latest entry)
      #         additionalProperties: false
      #       default: []
      #   required: [entries]
      #   additionalProperties: false
      #   default:
      #     entries: []

      # historyEntryIndex:
      #   type: integer
      #   description: Current index in history entries
      #   minimum: 0

      nextLineConfig:
        type: object
        description: Configuration for next line advancement
        properties:
          manual:
            type: object
            properties:
              enabled:
                type: boolean
                default: true
              requireComplete:
                type: boolean
                default: false
            additionalProperties: false
          auto:
            type: object
            properties:
              trigger:
                type: string
                enum: ["fromStart", "fromComplete"]
                default: "fromComplete"
              delay:
                type: number
                minimum: 0
                default: 1000
            required: [trigger, delay]
            additionalProperties: false
        additionalProperties: false
        default: {}
      viewedRegistry:
        type: object
        description: Registry of viewed content
        properties:
          sections:
            type: array
            description: Array of viewed sections and their last viewed lines
            items:
              type: object
              properties:
                sectionId:
                  type: string
                  description: ID of the section
                lastLineId:
                  type: [string, null]
                  description: ID of the last viewed line. If null/undefined, means entire section has been seen
              required: [sectionId]
              additionalProperties: false
            default: []
          resources:
            type: array
            description: Array of viewed resource IDs
            items:
              type: object
              properties:
                resourceId:
                  type: [string, number]
                  description: ID of the viewed resource
              required: [resourceId]
              additionalProperties: false
            default: []
        required: [sections, resources]
        additionalProperties: false

  contexts:
    description: Mode-specific state configurations
    type: array
    items:
      type: object
      description: Context
      properties:
        currentMode:
          type: string
          description: Current game mode
          enum: ["read", "history"]
          default: "read"
        currentPointer:
          type: string
          enum: ["read", "history"]
          default: "read"
        pointers:
          type: object
          properties:
            read:
              $ref: "#/defs/linePointer"
            history:
              $ref: "#/defs/linePointer"
        layeredViews:
          type: array
          items:
            type: object
            properties:
              resourceId:
                type: string
        bgm:
          properties:
            resourceId:
              type: string

        variables:
          type: object
          properties: {}

        configuration:
          $ref: "./configuration.yaml"

        historySequence:
          type: array
          description: History sequence tracking user interactions
          items:
            type: object
            description: History entry
            properties:
              sectionId:
                type: string
                description: ID of the section
              lineId:
                type: string
                description: ID of the line this entry corresponds to
              stateBefore:
                type: object
                description: Variable values before this line executed (only variables that changed)
                additionalProperties: true
          default: []

required:
  [variables, currentLanguagePackId, historySequence, currentMode, modes]
additionalProperties: false

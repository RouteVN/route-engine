file: "../../../src/stores/system.store.js"
group: systemStore.backtrackToLine
suites: [backtrackToLine]
---
suite: backtrackToLine
exportName: backtrackToLine
---
case: resets to initialState before replay
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines: []
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 999
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "4"
            history:
              sectionId: "section1"
              lineId: "2"
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
                - id: "4"
  - sectionId: "section1"
    lineId: "1"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines: []
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 0
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "1"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines: []
---
case: replays actions forward to line before target
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariable:
                          id: "act1"
                          operations:
                            - variableId: score
                              op: set
                              value: 15
                    - id: "3"
                      actions:
                        updateVariable:
                          id: "act2"
                          operations:
                            - variableId: score
                              op: increment
                              value: 10
                    - id: "4"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 25
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "4"
            history:
              sectionId: "section1"
              lineId: "2"
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
                - id: "3"
                  updateVariableIds:
                    - "act2"
                - id: "4"
  - sectionId: "section1"
    lineId: "3"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariable:
                      id: "act1"
                      operations:
                        - variableId: score
                          op: set
                          value: 15
                - id: "3"
                  actions:
                    updateVariable:
                      id: "act2"
                      operations:
                        - variableId: score
                          op: increment
                          value: 10
                - id: "4"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 15
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "act1"
---
case: handles missing action definitions gracefully (skips)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                    - id: "3"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 100
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "missingAction"
                - id: "3"
  - sectionId: "section1"
    lineId: "3"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 0
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "missingAction"
---
case: handles missing initialState gracefully (empty state)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 100
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "2"
            history: {}
          historySequence:
            - sectionId: "section1"
              lines:
                - id: "1"
                - id: "2"
  - sectionId: "section1"
    lineId: "1"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables: {}
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "1"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          lines: []
---
case: switches to read mode after backtrack
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines: []
        resources:
          variables: {}
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables: {}
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history:
              sectionId: "section1"
              lineId: "1"
              historySequenceIndex: 0
          historySequence:
            - sectionId: "section1"
              initialState: {}
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
  - sectionId: "section1"
    lineId: "2"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines: []
    resources:
      variables: {}
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables: {}
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "2"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState: {}
          lines:
            - id: "1"
---
case: returns unchanged state for invalid sectionId
in:
  - state:
      projectData:
        story:
          scenes: {}
        resources:
          variables: {}
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables: {}
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history:
              sectionId: "section1"
              lineId: "1"
          historySequence:
            - sectionId: "section1"
              initialState: {}
              lines:
                - id: "1"
  - sectionId: "nonExistentSection"
    lineId: "1"
out:
  projectData:
    story:
      scenes: {}
    resources:
      variables: {}
  global:
    isLineCompleted: true
    pendingEffects: []
  contexts:
    - variables: {}
      currentPointerMode: "history"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: "section1"
          lineId: "1"
      historySequence:
        - sectionId: "section1"
          initialState: {}
          lines:
            - id: "1"
---
case: returns unchanged state for invalid lineId
in:
  - state:
      projectData:
        story:
          scenes: {}
        resources:
          variables: {}
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables: {}
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history:
              sectionId: "section1"
              lineId: "1"
          historySequence:
            - sectionId: "section1"
              initialState: {}
              lines:
                - id: "1"
                - id: "2"
  - sectionId: "section1"
    lineId: "nonExistentLine"
out:
  projectData:
    story:
      scenes: {}
    resources:
      variables: {}
  global:
    isLineCompleted: true
    pendingEffects: []
  contexts:
    - variables: {}
      currentPointerMode: "history"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: "section1"
          lineId: "1"
      historySequence:
        - sectionId: "section1"
          initialState: {}
          lines:
            - id: "1"
            - id: "2"
---
case: handles multiple actions on same line
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariables:
                          - id: "act1"
                            operations:
                              - variableId: score
                                op: set
                                value: 10
                          - id: "act2"
                            operations:
                              - variableId: score
                                op: increment
                                value: 5
                    - id: "3"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 100
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history:
              sectionId: "section1"
              lineId: "1"
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
                    - "act2"
                - id: "3"
  - sectionId: "section1"
    lineId: "3"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariables:
                      - id: "act1"
                        operations:
                          - variableId: score
                            op: set
                            value: 10
                      - id: "act2"
                        operations:
                          - variableId: score
                            op: increment
                            value: 5
                - id: "3"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 15
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "act1"
                - "act2"
---
case: backtrack to first line resets to initialState only (no replay)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariable:
                          id: "act1"
                          operations:
                            - variableId: score
                              op: set
                              value: 50
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 50
          currentPointerMode: "history"
          pointers:
            read:
              sectionId: "section1"
              lineId: "2"
            history:
              sectionId: "section1"
              lineId: "1"
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 10
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
  - sectionId: "section1"
    lineId: "1"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariable:
                      id: "act1"
                      operations:
                        - variableId: score
                          op: set
                          value: 50
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 10
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "1"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 10
          lines: []
---
case: empty updateVariableIds results in no replay for that line
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                    - id: "3"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 100
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 5
              lines:
                - id: "1"
                  updateVariableIds: []
                - id: "2"
                  updateVariableIds: []
                - id: "3"
  - sectionId: "section1"
    lineId: "3"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 5
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 5
          lines:
            - id: "1"
              updateVariableIds: []
            - id: "2"
              updateVariableIds: []
---
case: global variables are NOT replayed during backtrack
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariable:
                          id: "globalAct"
                          operations:
                            - variableId: volume
                              op: set
                              value: 100
                    - id: "3"
        resources:
          variables:
            volume:
              type: number
              scope: global-device
              default: 50
      global:
        variables:
          volume: 100
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables: {}
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "3"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState: {}
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "globalAct"
                - id: "3"
  - sectionId: "section1"
    lineId: "3"
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariable:
                      id: "globalAct"
                      operations:
                        - variableId: volume
                          op: set
                          value: 100
                - id: "3"
    resources:
      variables:
        volume:
          type: number
          scope: global-device
          default: 50
  global:
    variables:
      volume: 100
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables: {}
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState: {}
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "globalAct"
---
case: backtrack using offset -1 (go back one line)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariable:
                          id: "act1"
                          operations:
                            - variableId: score
                              op: set
                              value: 10
                    - id: "3"
                      actions:
                        updateVariable:
                          id: "act2"
                          operations:
                            - variableId: score
                              op: increment
                              value: 5
                    - id: "4"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 15
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "4"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
                - id: "3"
                  updateVariableIds:
                    - "act2"
                - id: "4"
  - sectionId: "section1"
    offset: -1
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariable:
                      id: "act1"
                      operations:
                        - variableId: score
                          op: set
                          value: 10
                - id: "3"
                  actions:
                    updateVariable:
                      id: "act2"
                      operations:
                        - variableId: score
                          op: increment
                          value: 5
                - id: "4"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 10
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "act1"
---
case: backtrack using offset -2 (go back two lines)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                    - id: "3"
                    - id: "4"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 50
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "4"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
                - id: "4"
  - sectionId: "section1"
    offset: -2
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                - id: "3"
                - id: "4"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        score: 0
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "2"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
---
case: offset out of bounds (negative) returns unchanged state
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
        resources:
          variables: {}
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables: {}
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "1"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState: {}
              lines:
                - id: "1"
                - id: "2"
  - sectionId: "section1"
    offset: -1
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
    resources:
      variables: {}
  global:
    isLineCompleted: true
    pendingEffects: []
  contexts:
    - variables: {}
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "1"
        history: {}
      historySequence:
        - sectionId: "section1"
          initialState: {}
          lines:
            - id: "1"
            - id: "2"
---
case: offset with duplicate entries uses last occurrence (after backtrack and advance)
in:
  - state:
      projectData:
        story:
          scenes:
            scene1:
              sections:
                section1:
                  lines:
                    - id: "1"
                    - id: "2"
                      actions:
                        updateVariable:
                          id: "act1"
                          operations:
                            - variableId: score
                              op: set
                              value: 10
                    - id: "3"
                      actions:
                        updateVariable:
                          id: "act2"
                          operations:
                            - variableId: score
                              op: increment
                              value: 5
                    - id: "4"
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        isLineCompleted: true
        pendingEffects: []
      contexts:
        - variables:
            score: 15
          currentPointerMode: "read"
          pointers:
            read:
              sectionId: "section1"
              lineId: "4"
            history: {}
          historySequence:
            - sectionId: "section1"
              initialState:
                score: 0
              lines:
                # Original entries
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
                - id: "3"
                  updateVariableIds:
                    - "act2"
                - id: "4"
                # Duplicates from previous backtrack to line1 and advancing again
                - id: "1"
                - id: "2"
                  updateVariableIds:
                    - "act1"
                - id: "3"
                  updateVariableIds:
                    - "act2"
                - id: "4"
  - sectionId: "section1"
    offset: -1
out:
  projectData:
    story:
      scenes:
        scene1:
          sections:
            section1:
              lines:
                - id: "1"
                - id: "2"
                  actions:
                    updateVariable:
                      id: "act1"
                      operations:
                        - variableId: score
                          op: set
                          value: 10
                - id: "3"
                  actions:
                    updateVariable:
                      id: "act2"
                      operations:
                        - variableId: score
                          op: increment
                          value: 5
                - id: "4"
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    isLineCompleted: false
    pendingEffects:
      - name: "render"
      - name: "handleLineActions"
  contexts:
    - variables:
        # Replayed lines 0-6 (before target index 7):
        # line1 + line2(set=10) + line3(+5) + line4 + line1 + line2(set=10)
        # = 10 (set overwrites to 10 twice, but final is still 10)
        score: 10
      currentPointerMode: "read"
      pointers:
        read:
          sectionId: "section1"
          lineId: "3"
        history:
          sectionId: null
          lineId: null
          historySequenceIndex: null
      historySequence:
        - sectionId: "section1"
          initialState:
            score: 0
          lines:
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "act1"
            - id: "3"
              updateVariableIds:
                - "act2"
            - id: "4"
            - id: "1"
            - id: "2"
              updateVariableIds:
                - "act1"

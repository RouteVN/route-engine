file: "../../../src/stores/system.store.js"
group: systemStore.updateVariable
suites: [updateVariable]
---
suite: updateVariable
exportName: updateVariable
---
case: set context variable
in:
  - state:
      projectData:
        resources:
          variables:
            playerName:
              type: string
              scope: context
              default: "Guest"
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            playerName: "Guest"
  - id: "test1"
    operations:
      - variableId: playerName
        op: set
        value: "Alice"
out:
  projectData:
    resources:
      variables:
        playerName:
          type: string
          scope: context
          default: "Guest"
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        playerName: "Alice"
---
case: set global-device variable
in:
  - state:
      projectData:
        resources:
          variables:
            volume:
              type: number
              scope: global-device
              default: 50
      global:
        variables:
          volume: 50
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test2"
    operations:
      - variableId: volume
        op: set
        value: 80
out:
  projectData:
    resources:
      variables:
        volume:
          type: number
          scope: global-device
          default: 50
  global:
    variables:
      volume: 80
    pendingEffects:
      - name: "saveGlobalDeviceVariables"
        payload:
          globalDeviceVariables:
            volume: 80
      - name: "render"
  contexts:
    - variables: {}
---
case: set global-account variable
in:
  - state:
      projectData:
        resources:
          variables:
            achievement1:
              type: boolean
              scope: global-account
              default: false
      global:
        variables:
          achievement1: false
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test3"
    operations:
      - variableId: achievement1
        op: set
        value: true
out:
  projectData:
    resources:
      variables:
        achievement1:
          type: boolean
          scope: global-account
          default: false
  global:
    variables:
      achievement1: true
    pendingEffects:
      - name: "saveGlobalAccountVariables"
        payload:
          globalAccountVariables:
            achievement1: true
      - name: "render"
  contexts:
    - variables: {}
---
case: increment context number (default value 1)
in:
  - state:
      projectData:
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            score: 100
  - id: "test4"
    operations:
      - variableId: score
        op: increment
out:
  projectData:
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        score: 101
---
case: toggle context boolean
in:
  - state:
      projectData:
        resources:
          variables:
            soundEnabled:
              type: boolean
              scope: context
              default: true
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            soundEnabled: true
  - id: "test5"
    operations:
      - variableId: soundEnabled
        op: toggle
out:
  projectData:
    resources:
      variables:
        soundEnabled:
          type: boolean
          scope: context
          default: true
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        soundEnabled: false
---
case: toggle global-device boolean
in:
  - state:
      projectData:
        resources:
          variables:
            notificationsOn:
              type: boolean
              scope: global-device
              default: false
      global:
        variables:
          notificationsOn: false
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test6"
    operations:
      - variableId: notificationsOn
        op: toggle
out:
  projectData:
    resources:
      variables:
        notificationsOn:
          type: boolean
          scope: global-device
          default: false
  global:
    variables:
      notificationsOn: true
    pendingEffects:
      - name: "saveGlobalDeviceVariables"
        payload:
          globalDeviceVariables:
            notificationsOn: true
      - name: "render"
  contexts:
    - variables: {}
---
case: multiple operations - mixed scopes
in:
  - state:
      projectData:
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
            volume:
              type: number
              scope: global-device
              default: 50
            achievement1:
              type: boolean
              scope: global-account
              default: false
      global:
        variables:
          volume: 50
          achievement1: false
        pendingEffects: []
      contexts:
        - variables:
            score: 100
  - id: "test7"
    operations:
      - variableId: score
        op: increment
      - variableId: volume
        op: set
        value: 80
      - variableId: achievement1
        op: set
        value: true
out:
  projectData:
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
        volume:
          type: number
          scope: global-device
          default: 50
        achievement1:
          type: boolean
          scope: global-account
          default: false
  global:
    variables:
      volume: 80
      achievement1: true
    pendingEffects:
      - name: "saveGlobalDeviceVariables"
        payload:
          globalDeviceVariables:
            volume: 80
      - name: "saveGlobalAccountVariables"
        payload:
          globalAccountVariables:
            achievement1: true
      - name: "render"
  contexts:
    - variables:
        score: 101
---
case: increment undefined context variable (should become 1)
in:
  - state:
      projectData:
        resources:
          variables:
            newCounter:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test8"
    operations:
      - variableId: newCounter
        op: increment
out:
  projectData:
    resources:
      variables:
        newCounter:
          type: number
          scope: context
          default: 0
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        newCounter: 1
---
case: increment context number with custom value
in:
  - state:
      projectData:
        resources:
          variables:
            gold:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            gold: 50
  - id: "test9"
    operations:
      - variableId: gold
        op: increment
        value: 25
out:
  projectData:
    resources:
      variables:
        gold:
          type: number
          scope: context
          default: 0
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        gold: 75
---
case: decrement context number with custom value
in:
  - state:
      projectData:
        resources:
          variables:
            health:
              type: number
              scope: context
              default: 100
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            health: 100
  - id: "test10"
    operations:
      - variableId: health
        op: decrement
        value: 30
out:
  projectData:
    resources:
      variables:
        health:
          type: number
          scope: context
          default: 100
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        health: 70
---
case: multiply context number
in:
  - state:
      projectData:
        resources:
          variables:
            multiplier:
              type: number
              scope: context
              default: 1
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            multiplier: 2
  - id: "test11"
    operations:
      - variableId: multiplier
        op: multiply
        value: 3
out:
  projectData:
    resources:
      variables:
        multiplier:
          type: number
          scope: context
          default: 1
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        multiplier: 6
---
case: divide context number
in:
  - state:
      projectData:
        resources:
          variables:
            value:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            value: 100
  - id: "test12"
    operations:
      - variableId: value
        op: divide
        value: 4
out:
  projectData:
    resources:
      variables:
        value:
          type: number
          scope: context
          default: 0
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        value: 25
---
case: decrement context number (default value 1)
in:
  - state:
      projectData:
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            score: 100
  - id: "test13"
    operations:
      - variableId: score
        op: decrement
out:
  projectData:
    resources:
      variables:
        score:
          type: number
          scope: context
          default: 0
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        score: 99
---
case: error - missing scope
in:
  - state:
      projectData:
        resources:
          variables:
            badVar:
              type: number
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test14"
    operations:
      - variableId: badVar
        op: set
        value: 10
throws: "Variable scope is required for variable: badVar"
---
case: error - invalid scope
in:
  - state:
      projectData:
        resources:
          variables:
            badVar:
              type: number
              scope: invalid
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test15"
    operations:
      - variableId: badVar
        op: set
        value: 10
throws: "Invalid variable scope: invalid for variable badVar. Expected one of: context, global-device, global-account"
---
case: error - unknown variable type
in:
  - state:
      projectData:
        resources:
          variables:
            badVar:
              type: customType
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test16"
    operations:
      - variableId: badVar
        op: set
        value: 10
throws: "Unknown variable type: customType for variable badVar"
---
case: error - invalid operation for boolean
in:
  - state:
      projectData:
        resources:
          variables:
            flag:
              type: boolean
              scope: context
              default: false
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            flag: false
  - id: "test17"
    operations:
      - variableId: flag
        op: increment
throws: "Operation \"increment\" is not valid for variable \"flag\" of type \"boolean\". Valid operations: set, toggle"
---
case: error - invalid operation for string
in:
  - state:
      projectData:
        resources:
          variables:
            name:
              type: string
              scope: context
              default: ""
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            name: "Alice"
  - id: "test18"
    operations:
      - variableId: name
        op: multiply
        value: 2
throws: "Operation \"multiply\" is not valid for variable \"name\" of type \"string\". Valid operations: set"
---
case: error - invalid operation for number
in:
  - state:
      projectData:
        resources:
          variables:
            count:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            count: 42
  - id: "test19"
    operations:
      - variableId: count
        op: toggle
throws: "Operation \"toggle\" is not valid for variable \"count\" of type \"number\". Valid operations: set, increment, decrement, multiply, divide"
---
case: error - unknown operation
in:
  - state:
      projectData:
        resources:
          variables:
            score:
              type: number
              scope: context
              default: 0
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            score: 100
  - id: "test20"
    operations:
      - variableId: score
        op: unknown
        value: 5
throws: "Unknown operation: unknown"
---
case: set context object variable
in:
  - state:
      projectData:
        resources:
          variables:
            inventory:
              type: object
              scope: context
              default:
                items: []
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            inventory:
              items: []
  - id: "test21"
    operations:
      - variableId: inventory
        op: set
        value:
          items:
            - id: sword
              name: Steel Sword
out:
  projectData:
    resources:
      variables:
        inventory:
          type: object
          scope: context
          default:
            items: []
  global:
    variables: {}
    pendingEffects:
      - name: "render"
  contexts:
    - variables:
        inventory:
          items:
            - id: sword
              name: Steel Sword
---
case: set global-device object variable
in:
  - state:
      projectData:
        resources:
          variables:
            pageButtons:
              type: object
              scope: global-device
              default:
                items: []
      global:
        variables:
          pageButtons:
            items: []
        pendingEffects: []
      contexts:
        - variables: {}
  - id: "test22"
    operations:
      - variableId: pageButtons
        op: set
        value:
          items:
            - label: A
              value: -1
            - label: Q
              value: 0
out:
  projectData:
    resources:
      variables:
        pageButtons:
          type: object
          scope: global-device
          default:
            items: []
  global:
    variables:
      pageButtons:
        items:
          - label: A
            value: -1
          - label: Q
            value: 0
    pendingEffects:
      - name: "saveGlobalDeviceVariables"
        payload:
          globalDeviceVariables:
            pageButtons:
              items:
                - label: A
                  value: -1
                - label: Q
                  value: 0
      - name: "render"
  contexts:
    - variables: {}
---
case: error - invalid operation for object
in:
  - state:
      projectData:
        resources:
          variables:
            data:
              type: object
              scope: context
              default: {}
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            data: {}
  - id: "test23"
    operations:
      - variableId: data
        op: increment
throws: "Operation \"increment\" is not valid for variable \"data\" of type \"object\". Valid operations: set"
---
case: error - missing id field
in:
  - state:
      projectData:
        resources:
          variables:
            testContextVar1:
              type: number
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            testContextVar1: 0
  - operations:
      - variableId: testContextVar1
        op: set
        value: 100
throws: "updateVariable requires an id field"
---
case: error - id with hyphen
in:
  - state:
      projectData:
        resources:
          variables:
            testContextVar1:
              type: number
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            testContextVar1: 0
  - id: "invalid-id"
    operations:
      - variableId: testContextVar1
        op: set
        value: 100
throws: "updateVariable id must be alphanumeric, got: \"invalid-id\""
---
case: error - id with underscore
in:
  - state:
      projectData:
        resources:
          variables:
            testContextVar1:
              type: number
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            testContextVar1: 0
  - id: "invalid_id"
    operations:
      - variableId: testContextVar1
        op: set
        value: 100
throws: "updateVariable id must be alphanumeric, got: \"invalid_id\""
---
case: error - id with space
in:
  - state:
      projectData:
        resources:
          variables:
            testContextVar1:
              type: number
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            testContextVar1: 0
  - id: "invalid id"
    operations:
      - variableId: testContextVar1
        op: set
        value: 100
throws: "updateVariable id must be alphanumeric, got: \"invalid id\""
---
case: error - empty id
in:
  - state:
      projectData:
        resources:
          variables:
            testContextVar1:
              type: number
              scope: context
      global:
        variables: {}
        pendingEffects: []
      contexts:
        - variables:
            testContextVar1: 0
  - id: ""
    operations:
      - variableId: testContextVar1
        op: set
        value: 100
throws: "updateVariable requires an id field"
